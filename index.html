<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>From Lines to Pictures - Images as 2D Signals</title>
    <style>
* {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #ffffff;
            min-height: 100vh;
            color: #2d3748;
            line-height: 1.6;
        }

        /* Progress Bar */
        .progress-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
            width: 0%;
            transition: width 0.5s ease;
            box-shadow: 0 0 10px rgba(79, 172, 254, 0.5);
        }



        /* Main Container */
        .lesson-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        /* Section Cards */
        section {
            background: transparent;
            margin-bottom: 30px;
            padding: 20px 0;
            display: none;
            opacity: 0;
            transition: all 0.6s ease;
            transform: translateY(20px);
        }

        section.visible {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        /* Typography */
        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 1.5rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1.2;
        }

        h2 {
            font-size: 2rem;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 1.5rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 1rem;
        }

        p {
            font-size: 1.125rem;
            line-height: 1.7;
            color: #4a5568;
            margin-bottom: 1.5rem;
        }

        ul {
            margin-left: 1.5rem;
            margin-bottom: 1.5rem;
        }

        li {
            font-size: 1.125rem;
            line-height: 1.7;
            color: #4a5568;
            margin-bottom: 0.5rem;
        }

        strong {
            color: #2d3748;
            font-weight: 600;
        }

        em {
            color: #667eea;
            font-style: normal;
            font-weight: 500;
        }

        /* Image Placeholders */
        .image-placeholder {
            margin: 2rem 0;
        }

        /* Confetti Animation */
        .confetti-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
            overflow: hidden;
        }

        .confetti {
            position: absolute;
            font-size: 20px;
            animation: confetti-fall 3s linear infinite;
        }

        @keyframes confetti-fall {
            0% {
                transform: translateY(-100vh) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }

        .confetti:nth-child(odd) {
            animation-duration: 2.5s;
            animation-delay: 0.2s;
        }

        .confetti:nth-child(even) {
            animation-duration: 3.5s;
            animation-delay: 0.5s;
        }

        .confetti:nth-child(3n) {
            animation-duration: 2.8s;
            animation-delay: 0.8s;
        }

        .confetti:nth-child(4n) {
            animation-duration: 3.2s;
            animation-delay: 0.3s;
        }

        .confetti:nth-child(5n) {
            animation-duration: 2.7s;
            animation-delay: 0.7s;
        }

        /* Success Message Animation */
        .success-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 20px 30px;
            border-radius: 12px;
            font-size: 1.2em;
            font-weight: 600;
            box-shadow: 0 10px 25px rgba(40, 167, 69, 0.3);
            z-index: 10000;
            opacity: 0;
            animation: success-popup 2.5s ease-out;
            pointer-events: none;
        }

        @keyframes success-popup {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.5);
            }
            20% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.1);
            }
            40% {
                transform: translate(-50%, -50%) scale(1);
            }
            80% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
            100% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.9);
            }
        }

        .image-placeholder img {
            width: 100%;
            height: auto;
            display: block;
            margin: 0 auto;
        }
        
        /* Specific sizing for individual images by section */
        #section1 .image-placeholder img {
            width: 70% !important;              /* Image 1: 70% (dramatic light beam) */
            max-width: 500px !important;
        }

        #section6 .image-placeholder img {
            width: 55% !important;              /* Image 2: 50-60% (meme image) */
            max-width: 400px !important;
        }
        
        #section9 .image-placeholder img {
            width: 85% !important;              /* Image 3: 80-90% (prism diagram) */
            max-width: 600px !important;
        }
        
        #section13 .image-placeholder img {
            width: 85% !important;              /* Image 4: 80-90% (red object) */
            max-width: 600px !important;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            #section1 .image-placeholder img {
                width: 80% !important;
                max-width: 400px !important;
            }

            #section6 .image-placeholder img {
                width: 65% !important;
                max-width: 350px !important;
            }
            
            #section9 .image-placeholder img,
            #section13 .image-placeholder img {
                width: 90% !important;
                max-width: 450px !important;
            }
        }
        
        @media (max-width: 480px) {
            #section1 .image-placeholder img {
                width: 85% !important;
                max-width: 300px !important;
            }

            #section6 .image-placeholder img {
                width: 75% !important;
                max-width: 280px !important;
            }
            
            #section9 .image-placeholder img,
            #section13 .image-placeholder img {
                width: 95% !important;
                max-width: 320px !important;
            }
        }

        /* Content Boxes */
        .vocab-section, .why-it-matters, .test-your-knowledge, .faq-section, 
        .stop-and-think, .check-your-knowledge {
            margin: 2rem 0;
            padding: 2rem;
            border-radius: 8px;
            border-left: 4px solid;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .vocab-section::before, .why-it-matters::before, .test-your-knowledge::before,
        .faq-section::before, .stop-and-think::before, .check-your-knowledge::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            opacity: 0.05;
            z-index: 0;
        }

        .vocab-section {
            background: linear-gradient(135deg, #e6f3ff 0%, #f0f8ff 100%);
            border-left-color: #4facfe;
            box-shadow: 0 10px 30px rgba(79, 172, 254, 0.1);
        }

        .vocab-section::before {
            background: linear-gradient(45deg, #4facfe, #00f2fe);
        }

        .why-it-matters {
            background: linear-gradient(135deg, #ffeef7 0%, #fff0f8 100%);
            border-left-color: #f093fb;
            box-shadow: 0 10px 30px rgba(240, 147, 251, 0.1);
        }

        .why-it-matters::before {
            background: linear-gradient(45deg, #f093fb, #f5576c);
        }

        .test-your-knowledge, .check-your-knowledge {
            background: linear-gradient(135deg, #eafaf1 0%, #f0fcf4 100%);
            border-left-color: #68d391;
            box-shadow: 0 10px 30px rgba(104, 211, 145, 0.1);
        }

        .test-your-knowledge::before, .check-your-knowledge::before {
            background: linear-gradient(45deg, #68d391, #4fd1c7);
        }

        .faq-section {
            background: linear-gradient(135deg, #fffbeb 0%, #fefcf3 100%);
            border-left-color: #fbbf24;
            box-shadow: 0 10px 30px rgba(251, 191, 36, 0.1);
        }

        .faq-section::before {
            background: linear-gradient(45deg, #fbbf24, #f59e0b);
        }

        .stop-and-think {
            background: linear-gradient(135deg, #f3e8ff 0%, #f8f4ff 100%);
            border-left-color: #a78bfa;
            box-shadow: 0 10px 30px rgba(167, 139, 250, 0.1);
        }

        .stop-and-think::before {
            background: linear-gradient(45deg, #a78bfa, #8b5cf6);
        }

        .vocab-section:hover, .why-it-matters:hover, .test-your-knowledge:hover,
        .faq-section:hover, .stop-and-think:hover, .check-your-knowledge:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
        }

        .vocab-section h3 {
            color: #0ea5e9;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 700;
            margin-bottom: 1rem;
            position: relative;
            z-index: 1;
        }

        .why-it-matters h3 {
            color: #ec4899;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 700;
            margin-bottom: 1rem;
            position: relative;
            z-index: 1;
        }

        .test-your-knowledge h3, .check-your-knowledge h3 {
            color: #10b981;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 700;
            margin-bottom: 1rem;
            position: relative;
            z-index: 1;
        }

        .faq-section h3 {
            color: #d97706;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 700;
            margin-bottom: 1rem;
            position: relative;
            z-index: 1;
        }

        .stop-and-think h3 {
            color: #8b5cf6;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 700;
            margin-bottom: 1rem;
            position: relative;
            z-index: 1;
        }

        .vocab-section h4, .test-your-knowledge h4, .check-your-knowledge h4, .faq-section h4 {
            color: #2d3748;
            font-size: 1.25rem;
            font-weight: 600;
            margin: 1.5rem 0 1rem 0;
            position: relative;
            z-index: 1;
        }

        .vocab-term {
            color: #0ea5e9;
            font-weight: 600;
        }

        /* Buttons */
        .continue-button, .reveal-button, .check-button {
            display: inline-block;
            padding: 16px 32px;
            margin-top: 2rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 50px;
            text-decoration: none;
            cursor: pointer;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
            position: relative;
            overflow: hidden;
        }

        .continue-button::before, .reveal-button::before, .check-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .continue-button:hover, .reveal-button:hover, .check-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.4);
        }

        .continue-button:hover::before, .reveal-button:hover::before, .check-button:hover::before {
            left: 100%;
        }

        .continue-button:active, .reveal-button:active, .check-button:active {
            transform: translateY(-1px);
        }

        /* Hidden state for conditional buttons */
        .continue-button[style*="display: none"] {
            display: none !important;
        }

        /* Ensure all conditional continue buttons match normal button styling exactly when shown */
        #continue-after-interactive:not([style*="display: none"]),
        #continue-after-check-knowledge:not([style*="display: none"]),
        #continue-after-test-knowledge:not([style*="display: none"]) {
            display: inline-block !important;
            width: auto !important;
            max-width: none !important;
            min-width: auto !important;
            padding: 16px 32px !important;
            margin: 30px auto !important;
            box-sizing: border-box !important;
        }

        /* Center ALL continue buttons by making all sections center them */
        section {
            text-align: center;
        }

        /* Reset text alignment for all content except continue buttons */
        section > *:not(.continue-button) {
            text-align: left;
        }

        /* Ensure content boxes also have left alignment */
        .check-your-knowledge,
        .test-your-knowledge,
        .vocab-section,
        .why-it-matters,
        .faq-section,
        .stop-and-think {
            text-align: left;
        }

        /* Smooth appearance for conditional continue buttons */
        .continue-button.show-with-animation {
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInUp 0.6s ease-out forwards;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Multiple Choice */
        .multiple-choice {
            margin: 1.5rem 0;
        }

        .choice-option {
            display: block;
            margin: 1rem 0;
            padding: 1.5rem;
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
            font-weight: 500;
            position: relative;
            overflow: hidden;
        }

        .choice-option::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 0;
        }

        .choice-option:hover {
            transform: translateX(5px);
            border-color: rgba(102, 126, 234, 0.3);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.15);
        }

        .choice-option:hover::before {
            opacity: 0.05;
        }

        .choice-option.selected, .choice-option.correct {
            background: linear-gradient(135deg, #eafaf1 0%, #f0fcf4 100%);
            border-color: #68d391;
            color: #2d3748;
        }

        .choice-option.incorrect {
            background: linear-gradient(135deg, #fef2f2 0%, #fef7f7 100%);
            border-color: #f87171;
            color: #2d3748;
        }

        .choice-explanation {
            display: none;
            margin-top: 1rem;
            padding: 1rem;
            background: #f1f5f9;
            border-radius: 8px;
            font-size: 0.9rem;
            line-height: 1.6;
            animation: fadeIn 0.5s ease;
            position: relative;
            z-index: 1;
        }

        /* Spectrum Explorer - keeping the interactive styles but updating colors */
        .spectrum-explorer {
            position: relative;
            width: 100%;
            max-width: 100%;
            margin: 2rem 0;
            background: #ffffff;
            border: 1px solid #e2e8f0;
            padding: 40px;
        }

        .stage {
            min-height: 400px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .stage-text h3 {
            font-size: 1.75rem;
            font-weight: 600;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0 0 16px 0;
        }

        .instruction {
            font-size: 1.1rem;
            color: #6b7280;
            margin: 0;
            padding: 16px 24px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 12px;
            border: 2px dashed rgba(102, 126, 234, 0.3);
        }

        .continue-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        .continue-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.4);
        }

        .revelation-text h3 {
            font-size: 2rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0 0 16px 0;
        }

        .spectrum-point {
            border-radius: 16px;
            transition: all 0.3s ease;
            border: 2px solid #e2e8f0;
            background: #ffffff;
        }

        .spectrum-point:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.2);
            border-color: rgba(102, 126, 234, 0.3);
        }

        .spectrum-point.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.4);
        }

        .info-panel {
            background: #ffffff;
            border-radius: 16px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            padding: 24px;
        }

        .region-title {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .hook {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .lesson-container {
                padding: 20px 15px;
            }

            section {
                padding: 15px 0;
                margin-bottom: 20px;
            }

            h1 {
                font-size: 2rem;
            }

            h2 {
                font-size: 1.75rem;
            }

            p, li {
                font-size: 1rem;
            }



            .continue-button, .reveal-button, .check-button {
                width: 100%;
            text-align: center;
                margin-top: 1.5rem;
            }

            .spectrum-explorer {
                padding: 20px;
            }

            .choice-option {
                padding: 1rem;
            }

            .mark-completed-button {
                padding: 14px 28px;
                font-size: 0.9rem;
                margin: 30px auto 15px auto;
            }
        }

        @media (max-width: 480px) {
            .lesson-container {
                padding: 15px 10px;
            }

            section {
                padding: 10px 0;
            }

            h1 {
                font-size: 1.75rem;
            }

            .vocab-section, .why-it-matters, .test-your-knowledge, 
            .faq-section, .stop-and-think, .check-your-knowledge {
                padding: 1.5rem;
            }

            .mark-completed-button {
                padding: 12px 24px;
                font-size: 0.85rem;
                margin: 25px auto 10px auto;
            }
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-in {
            animation: fadeIn 0.5s ease-out;
        }

        /* Accessibility */
        .choice-option:focus {
            outline: 2px solid #667eea;
            outline-offset: 2px;
        }

        .continue-button:focus, .reveal-button:focus, .check-button:focus {
            outline: 2px solid white;
            outline-offset: 2px;
        }

        /* Content positioning */
        .vocab-section *, .why-it-matters *, .test-your-knowledge *, 
        .faq-section *, .stop-and-think *, .check-your-knowledge * {
            position: relative;
            z-index: 1;
        }

        /* Mark as Completed Button */
        .mark-completed-button {
            display: none;
            width: 100%;
            max-width: 400px;
            margin: 40px auto 20px auto;
            padding: 16px 32px;
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(72, 187, 120, 0.3);
            text-align: center;
            text-decoration: none;
        }

        .mark-completed-button.show {
            display: block;
        }

        .mark-completed-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(72, 187, 120, 0.4);
            background: linear-gradient(135deg, #38a169 0%, #2f855a 100%);
        }

        .mark-completed-button:active {
            transform: translateY(0);
        }

        .mark-completed-button.completed {
            background: linear-gradient(135deg, #94a3b8 0%, #64748b 100%);
            box-shadow: 0 4px 20px rgba(148, 163, 184, 0.3);
            cursor: default;
        }

        .mark-completed-button.completed:hover {
            background: linear-gradient(135deg, #94a3b8 0%, #64748b 100%);
            box-shadow: 0 4px 20px rgba(148, 163, 184, 0.3);
            transform: none;
        }

        /* Success Message */
        .lesson-success-message {
            text-align: center;
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 600;
            margin: 20px auto;
            max-width: 300px;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s ease;
        }

        .lesson-success-message.show {
            opacity: 1;
            transform: translateY(0);
        }



        /* Spectrum Explorer specific modern styles */
        .spectrum-explorer {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }

        .prism-svg {
            cursor: pointer;
            user-select: none;
            margin-bottom: 24px;
            filter: drop-shadow(0 10px 30px rgba(0,0,0,0.1));
            border-radius: 12px;
        }

        .visible-indicator {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 2px solid #667eea;
            color: #667eea;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.2);
        }

        .scale-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.875rem;
            color: #6b7280;
            font-weight: 500;
        }

        .scale-label.visible {
            color: #667eea;
            font-weight: 600;
        }

        .exploration-progress {
            text-align: center;
            margin-top: 20px;
            padding: 16px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }

        .progress-text {
            font-size: 0.875rem;
            color: #667eea;
            font-weight: 600;
        }



        /* Keep all other spectrum explorer functionality styles */
        .spectrum-bar {
            position: relative;
            width: 100%;
            height: 60px;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        #spectrum-canvas {
            width: 100%;
            height: 100%;
            border-radius: 12px;
        }

        .spectrum-points {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 0 0 24px 0;
            gap: 8px;
        }

        .spectrum-point {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 12px 8px;
            cursor: pointer;
            min-width: 80px;
            outline: none;
        }

        .point-icon {
            font-size: 1.5rem;
        }
        
        .point-label {
            font-size: 0.75rem;
            font-weight: 600;
            text-align: center;
        }

        .energy-scale {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 16px;
        }

        .energy-label {
            font-size: 0.875rem;
            color: #6b7280;
            white-space: nowrap;
            font-weight: 500;
        }

        .energy-bar {
            flex: 1;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }

        .energy-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981 0%, #f59e0b 50%, #ef4444 100%);
            transition: width 0.5s ease;
            border-radius: 4px;
        }

        .panel-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 20px;
        }
        
        .panel-header .region-icon {
            color: initial !important;
            background: none !important;
            -webkit-text-fill-color: initial !important;
            background-clip: initial !important;
        }
        
        /* Fix emoji colors in revelation text and all spectrum content */
        .revelation-text h3,
        .revelation-text,
        .spectrum-point .point-icon,
        h3 {
            color: inherit;
        }
        
        /* Target emojis specifically to prevent color inheritance */
        .revelation-text h3::after,
        .revelation-text h3 *,
        .spectrum-point .point-icon,
        .point-icon {
            background: none !important;
            -webkit-background-clip: initial !important;
            -webkit-text-fill-color: initial !important;
            background-clip: initial !important;
            color: initial !important;
            font-family: "Apple Color Emoji", "Segoe UI Emoji", "Noto Color Emoji", sans-serif !important;
        }
        
        /* Specific fix for Mind = Blown emoji */
        .revelation-text h3 {
            background: none !important;
            -webkit-background-clip: initial !important;
            -webkit-text-fill-color: initial !important;
            background-clip: initial !important;
        }
        
        /* Universal emoji fix */
        span[style*="color: initial"],
        .emoji-fix {
            font-family: "Apple Color Emoji", "Segoe UI Emoji", "Noto Color Emoji", "Segoe UI Symbol", sans-serif !important;
            font-style: normal !important;
            font-variant: normal !important;
            text-rendering: auto !important;
            -webkit-font-smoothing: auto !important;
        }
        
        /* Additional emoji protection */
        .revelation-text span,
        .spectrum-point .point-icon {
            display: inline !important;
            text-decoration: none !important;
            font-weight: normal !important;
        }

        .region-icon {
            font-size: 2rem;
            color: initial;
            text-shadow: none;
            filter: none;
            display: inline-block;
            font-family: "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", sans-serif;
        }

        .story-content {
            margin-bottom: 24px;
        }

        .description {
            font-size: 1rem;
            line-height: 1.6;
            margin: 0;
            color: #6b7280;
        }

        .tech-specs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .spec-item {
            text-align: center;
            padding: 12px;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(102, 126, 234, 0.1);
        }

        .spec-label {
            display: block;
            font-size: 0.75rem;
            color: #6b7280;
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 4px;
            letter-spacing: 0.05em;
        }

        .spec-value {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            color: #374151;
        }

        .color-display {
            margin-top: 16px;
        }

        .color-swatch {
            height: 40px;
            border-radius: 12px;
            margin-bottom: 8px;
            border: 2px solid rgba(102, 126, 234, 0.2);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .color-note {
            font-size: 0.875rem;
            color: #6b7280;
            margin: 0;
            font-style: italic;
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Row-to-1D Explorer */
        .row-explorer {
            display: grid;
            grid-template-columns: 340px 1fr;
            gap: 24px;
            align-items: start;
            margin: 1.5rem 0;
            padding: 24px;
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.06);
        }

        .row-explorer .panel-left {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        #re2d {
            border-radius: 8px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.08);
            border: 1px solid #e5e7eb;
            cursor: crosshair;
            background: #f8fafc;
        }

        .row-label {
            font-size: 0.875rem;
            color: #6b7280;
            font-weight: 600;
        }

        #rowSlider {
            width: 100%;
        }

        #rowPreview {
            width: 100%;
            height: 20px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            background: #fff;
        }

        #signalChart {
            width: 100%;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: #fff;
        }

        .row-explorer .controls {
            display: flex;
            gap: 16px;
            align-items: center;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .row-explorer .controls input[type="range"] {
            vertical-align: middle;
        }

        @media (max-width: 900px) {
            .row-explorer {
                grid-template-columns: 1fr;
            }
        }

        /* Responsive design for spectrum explorer */
        @media (min-width: 768px) {
            .exploration-container {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 32px;
                align-items: start;
            }
            
            .spectrum-points {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .spectrum-point {
                min-width: 100px;
            }
        }

        @media (max-width: 480px) {
            .spectrum-explorer {
                padding: 20px;
            }
            
            .spectrum-points {
                display: grid;
                grid-template-columns: repeat(4, 1fr);
                gap: 12px;
            }
            
            .spectrum-point {
                min-width: auto;
            }
            
            .point-label {
                font-size: 0.7rem;
            }
            
            .tech-specs {
                grid-template-columns: 1fr;
            }
        }
</style>
    <meta name="description" content="Lesson: From Lines to Pictures - Images as 2D Signals">
    <meta name="theme-color" content="#667eea">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preload" as="style" href="about:blank">
    <link rel="preload" as="script" href="about:blank">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
</head>
<body>
    <div class="progress-container"><div class="progress-bar" id="progressBar"></div></div>

    <div class="lesson-container">
        <!-- Section 1: Intro -->
        <section id="section1" class="visible">
            <div class="image-placeholder">
                <img src="images/l61_1.png" alt="A meme format. Top panel shows a picture of the vast electromagnetic spectrum. Bottom panel shows a character squinting at a tiny, highlighted sliver labeled 'What I can actually see'. The character says, 'Well, that feels... limited.'">
            </div>
            <h1>From Lines to Pictures: Images as 2D Signals</h1>
            <p>In our last adventure, we saw how to break down 1D signals, like sound waves, into their fundamental frequencies. Now, we're going to take that powerful idea and apply it to something you look at every day: images. It's hard to believe, but a simple photograph is actually a complex tapestry of 'spatial frequencies'. In this first lesson, we'll discover how to see an image not just as a grid of pixels, but as a 2D signal, just waiting to be analyzed.</p>
            <div class="continue-button" onclick="showNextSection(2)">Continue</div>
        </section>

        <!-- Section 2: An Image is a Signal -->
        <section id="section2">
            <h2>An Image is a Signal</h2>
            <p>Have you ever wondered what an image <em>really</em> is to a computer? It's not just a collection of colors. At its core, it’s data that changes. A sound wave is a signal because its pressure level changes over <em>time</em>.</p>
            <div class="continue-button" onclick="showNextSection(3)">Continue</div>
        </section>

        <!-- Section 3 -->
        <section id="section3">
            <p>An image is a signal because its brightness and color values change over <em>space</em>—across two dimensions, horizontally and vertically. It’s a 2D spatial signal!</p>
            <div class="continue-button" onclick="showNextSection(4)">Continue</div>
        </section>

        <!-- Section 4 -->
        <section id="section4">
            <p>Play around with this interactive diagram to make it crystal clear. It's just a set of wavy vertical lines.</p>
            <div class="row-explorer" id="rowExplorer">
                <div class="panel-left">
                    <canvas id="re2d" width="300" height="300" aria-label="2D pattern"></canvas>
                    <div class="row-label">Row: <span id="rowValue">10</span></div>
                    <input id="rowSlider" type="range" min="0" max="299" value="10" aria-label="Row selector" />
            </div>
                <div class="panel-right">
                    <canvas id="rowPreview" width="300" height="20" aria-hidden="true"></canvas>
                    <canvas id="signalChart" width="600" height="260" aria-label="Row intensity signal"></canvas>
                    <div class="controls">
                        <button id="playBtn" class="continue-btn" type="button">Play</button>
                        <label class="energy-label">Base freq
                            <input id="freqInput" type="range" min="2" max="12" value="6" />
                        </label>
                        <label class="energy-label">Curvature
                            <input id="curveInput" type="range" min="0" max="10" value="3" />
                        </label>
                    </div>
                </div>
            </div>
            <div class="continue-button" id="continue-after-interactive" onclick="showNextSection(5)" style="display:none;">Continue</div>
        </section>

        <!-- Section 5 -->
        <section id="section5">
            <p>If we plot the brightness of the pixels along just one horizontal line, what do we get? A wave! Just like a sound signal. This is the key insight: we can use the same ideas of 'frequency' on images as we do on sounds.</p>
            <div class="continue-button" onclick="showNextSection(6)">Continue</div>
        </section>

        <!-- Section 6 -->
        <section id="section6">
            <p>In images, we call this <strong>spatial frequency</strong>.</p>
            <div class="image-placeholder">
                <img src="images/l61_2.png" alt="A meme format. Top panel shows a picture of the vast electromagnetic spectrum. Bottom panel shows a character squinting at a tiny, highlighted sliver labeled 'What I can actually see'. The character says, 'Well, that feels... limited.'">
            </div>
            <div class="continue-button" onclick="showNextSection(7)">Continue</div>
        </section>

        <!-- Section 7: Vocab -->
        <section id="section7">
            <p>A smooth, slowly changing area, like a clear blue sky or a plain wall, has <strong>low spatial frequencies</strong>. An area with lots of sharp details, like the text on a page or the texture of a carpet, has <strong>high spatial frequencies</strong>.</p>
            <div class="vocab-section">
                <h3>Build Your Vocab</h3>
                <h4 class="vocab-term">Spatial Signal</h4>
                <p>An image treated as a signal where the value (e.g., pixel intensity) varies over spatial dimensions (x and y).</p>
            </div>
            <div class="continue-button" onclick="showNextSection(8)">Continue</div>
        </section>

        <!-- Section 8: Identifying Frequencies -->
        <section id="section8">
            <h2>Identifying Frequencies</h2>
            <p>Let's put this new vocabulary to the test.</p>
            <div class="continue-button" onclick="showNextSection(9)">Continue</div>
        </section>

        <!-- Section 9: Stop and Think -->
        <section id="section9">
            <div class="stop-and-think">
                <h3>Stop and Think</h3>
                <p>Look at the room around you. Can you identify an object or surface that is made up of mostly 'low frequency' visual information and another that is 'high frequency'?</p>
                <div id="stop-reveal-1" class="choice-explanation" style="display:none;">
                    Hint: Think about texture and edges. A smooth, single-color wall has very low frequencies. A knitted sweater, a bookshelf full of books, or a patterned rug is full of high frequencies because the brightness changes very quickly and often.
                </div>
                <button class="reveal-button" onclick="revealText('stop-reveal-1', this)">Reveal</button>
            </div>
            <div class="continue-button" onclick="showNextSection(10)">Continue</div>
        </section>

        <!-- Section 10: Why it matters -->
        <section id="section10">
            <p>This very simple idea—that images are made of frequencies—is the foundation for some of the most important technologies in computer vision.</p>
            <div class="why-it-matters">
                <h3>Why It Matters</h3>
                <p>Why does this matter? Because thinking of images as signals is the conceptual key that unlocks frequency analysis. It allows us to borrow powerful tools from engineering and apply them to computer vision, enabling us to manipulate images in ways that would be impossible just by looking at pixels alone. This is the secret behind how JPEG compression can shrink a photo to a fraction of its size without you barely noticing!</p>
            </div>
            <div class="continue-button" onclick="showNextSection(11)">Continue</div>
        </section>

        <!-- Section 11: Test your knowledge -->
        <section id="section11">
            <p>Great! You now understand the fundamental concept that an image is a 2D signal. But how do we actually measure these frequencies? That's what we'll dive into in our next lesson, where we meet our special frequency-finding tool: the DCT.</p>
            <div class="test-your-knowledge">
                <h3>Test Your Knowledge</h3>
                <h4>Which of the following parts of an image would contain the highest spatial frequencies?</h4>
                <div class="multiple-choice">
                    <div class="choice-option" onclick="selectChoice(this, false, 'A clear blue sky.', 'A clear sky is very smooth and uniform, so it would have very low spatial frequencies.')">A clear blue sky.</div>
                    <div class="choice-option" onclick="selectChoice(this, false, 'A person\'s plain white t-shirt.', 'A plain t-shirt, like a clear sky, is a smooth area with very little change in brightness. This means it has low frequencies.')">A person's plain white t-shirt.</div>
                    <div class="choice-option" onclick="selectChoice(this, true, 'The sharp edge between a dark doorway and a light wall.', 'Exactly! An edge is where brightness changes very abruptly over a very small distance. This is the definition of a high-frequency component.')">The sharp edge between a dark doorway and a light wall.</div>
                    <div class="choice-option" onclick="selectChoice(this, false, 'A blurry, out-of-focus background.', 'Blurring, by its very nature, removes sharp details. A blurred background is a classic example of a low-frequency area.')">A blurry, out-of-focus background.</div>
                </div>
            </div>
            <div class="continue-button" id="continue-after-quiz" onclick="showNextSection(12)" style="display:none;">Continue</div>
        </section>

        <!-- Section 12: Review and Reflect -->
        <section id="section12">
            <h2>Review and Reflect</h2>
            <p>Let's take a moment to reflect on what we've learned.</p>
            <div class="continue-button" onclick="showNextSection(13)">Continue</div>
        </section>

 

        <!-- Section 14: Review text -->
        <section id="section13">
            <p class="md-text">In this lesson, we made the crucial conceptual leap from 1D signals to 2D images. We've learned that:
- An image can be viewed as a <strong>2D spatial signal</strong>, where pixel values change over space rather than time.
- The rate of this change is called <strong>spatial frequency</strong>. Smooth areas have low frequencies, while detailed areas with sharp edges have high frequencies.

This simple shift in perspective is incredibly powerful. Now that we know we can think of images as signals, we're ready to learn how to analyze their frequencies. In the next lesson, we will meet the mathematical tool that makes it all possible: the Discrete Cosine Transform (DCT).</p>
        </section>

        <!-- Mark as Completed Button -->
        <button id="markCompletedBtn" class="mark-completed-button" onclick="toggleCompleted()">✓ Mark as Completed</button>
        <div id="completionMessage" class="lesson-success-message">🎉 Lesson Completed! Great Job! 🎉</div>
    </div>

    <script>
        let currentSection = 1;
        const totalSections = 13;

        updateProgress();

        function showNextSection(nextSectionId) {
            const nextSectionElement = document.getElementById(`section${nextSectionId}`);
            const currentButton = event && event.target ? event.target : null;
            if (!nextSectionElement) return;

            if (currentButton) currentButton.style.display = 'none';
            nextSectionElement.classList.add('visible', 'animate-in');
            currentSection = nextSectionId;
            updateProgress();

            if (currentSection === totalSections) {
                const completedButton = document.getElementById('markCompletedBtn');
                if (completedButton) completedButton.classList.add('show');
            }

            setTimeout(() => {
                nextSectionElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 240);
        }

        function updateProgress() {
            const progressBar = document.getElementById('progressBar');
            const progress = (currentSection / totalSections) * 100;
            progressBar.style.width = `${progress}%`;
        }

        function revealText(id, btn) {
            const el = document.getElementById(id);
            if (el) {
                el.style.display = 'block';
                el.classList.add('animate-in');
            }
            if (btn) btn.style.display = 'none';
        }

        function selectChoice(element, isCorrect, optionText, explanation) {
            const group = element.parentNode.querySelectorAll('.choice-option');
            group.forEach(choice => {
                choice.classList.remove('selected', 'correct', 'incorrect');
                const existing = choice.querySelector('.choice-explanation');
                if (existing) existing.remove();
            });

            element.classList.add(isCorrect ? 'correct' : 'incorrect');

            const exp = document.createElement('div');
            exp.className = 'choice-explanation animate-in';
            exp.style.display = 'block';
            exp.innerHTML = `<strong>${isCorrect ? 'Correct!' : 'Not quite.'}</strong> ${explanation}`;
            element.appendChild(exp);

            const continueBtn = document.getElementById('continue-after-quiz');
            if (continueBtn && continueBtn.style.display === 'none') {
                setTimeout(() => {
                    continueBtn.style.display = 'inline-block';
                }, 700);
            }
        }

        // Keyboard navigation for continue
        document.addEventListener('keydown', function(e) {
            if (e.key === 'ArrowRight' || e.key === ' ') {
                const btn = document.querySelector(`#section${currentSection} .continue-button`);
                if (btn && btn.style.display !== 'none') {
                    e.preventDefault();
                    btn.click();
                }
            }
        });

        // Completion tracking (ProgressTracker + localStorage fallback)
        function toggleCompleted() {
            const button = document.getElementById('markCompletedBtn');
            if (!button || button.classList.contains('completed')) return;

            try {
                if (window.parent && window.parent.ProgressTracker) {
                    let courseId = 'computer-vision';
                    let pathId = 'fourier-transform-and-images';
                    let moduleId = 'cv-ch06-m1';
                    let lessonId = 'cv-ch06-l1-images-as-2d';

                    if (window.parent.currentRoute) {
                        const route = window.parent.currentRoute;
                        if (route.courseId) courseId = route.courseId;
                        if (route.pathId) pathId = route.pathId;
                        if (route.moduleId) moduleId = route.moduleId;
                        if (route.lessonId) lessonId = route.lessonId;
                    }

                    const urlParams = new URLSearchParams(window.location.search);
                    if (urlParams.get('course')) courseId = urlParams.get('course');
                    if (urlParams.get('path')) pathId = urlParams.get('path');
                    if (urlParams.get('module')) moduleId = urlParams.get('module');
                    if (urlParams.get('lesson')) lessonId = urlParams.get('lesson');

                    window.parent.ProgressTracker.markLessonCompleted(courseId, pathId, moduleId, lessonId);
                }
            } catch (err) { console.error('ProgressTracker error:', err); }

            button.classList.add('completed');
            button.innerHTML = '✅ Completed!';
            localStorage.setItem('lesson_cv-ch06-l1_completed', 'true');

            const message = document.getElementById('completionMessage');
            if (message) message.classList.add('show');
        }

        window.addEventListener('load', function() {
            const button = document.getElementById('markCompletedBtn');
            if (!button) return;

            try {
                if (window.parent && window.parent.ProgressTracker) {
                    let courseId = 'computer-vision';
                    let pathId = 'fourier-transform-and-images';
                    let moduleId = 'cv-ch06-m1';
                    let lessonId = 'cv-ch06-l1-images-as-2d';

                    if (window.parent.currentRoute) {
                        const route = window.parent.currentRoute;
                        if (route.courseId) courseId = route.courseId;
                        if (route.pathId) pathId = route.pathId;
                        if (route.moduleId) moduleId = route.moduleId;
                        if (route.lessonId) lessonId = route.lessonId;
                    }

                    const urlParams = new URLSearchParams(window.location.search);
                    if (urlParams.get('course')) courseId = urlParams.get('course');
                    if (urlParams.get('path')) pathId = urlParams.get('path');
                    if (urlParams.get('module')) moduleId = urlParams.get('module');
                    if (urlParams.get('lesson')) lessonId = urlParams.get('lesson');

                    const progress = window.parent.ProgressTracker.getLessonProgress(courseId, pathId, moduleId, lessonId);
                    if (progress && progress.state === window.parent.ProgressTracker.STATES.COMPLETED) {
                        button.classList.add('completed');
                        button.innerHTML = '✅ Completed!';
                        return;
                    }
                }
            } catch (err) { /* ignore */ }

            if (localStorage.getItem('lesson_cv-ch06-l1_completed') === 'true') {
                button.classList.add('completed');
                button.innerHTML = '✅ Completed!';
            }
        });

        // Expose initialize hook for host pages
        window.initializeCompletion = function(){};

        // Row-to-1D Explorer implementation
        (function initRowExplorer(){
            const container = document.getElementById('rowExplorer');
            if (!container) return;

            const canvas2d = document.getElementById('re2d');
            const ctx2d = canvas2d.getContext('2d');
            const slider = document.getElementById('rowSlider');
            const rowValue = document.getElementById('rowValue');
            const preview = document.getElementById('rowPreview');
            const pctx = preview.getContext('2d');
            const chart = document.getElementById('signalChart');
            const cctx = chart.getContext('2d');
            const playBtn = document.getElementById('playBtn');
            const freqInput = document.getElementById('freqInput');
            const curveInput = document.getElementById('curveInput');

            const W = canvas2d.width, H = canvas2d.height;
            const dpr = window.devicePixelRatio || 1;
            let baseImageData = ctx2d.createImageData(W, H);
            let playing = false;
            let lastInteractionRevealed = false;
            let animReq = null;

            function patternValue(x, y, f0, curve){
                const fy = f0 + (curve * (y / H));
                const phase = 2 * Math.PI * fy * (x / W);
                const s = Math.sin(phase + 0.4 * Math.sin(2 * Math.PI * y / (H * 0.8)));
                return 0.5 + 0.5 * s; // [0,1]
            }

            function generatePattern(){
                const f0 = Number(freqInput.value);
                const curve = Number(curveInput.value) * 0.15;
                const data = baseImageData.data;
                let i = 0;
                for (let y = 0; y < H; y++){
                    for (let x = 0; x < W; x++){
                        const v = Math.max(0, Math.min(1, patternValue(x, y, f0, curve)));
                        const g = (v * 255) | 0;
                        data[i++] = g; // R
                        data[i++] = g; // G
                        data[i++] = g; // B
                        data[i++] = 255; // A
                    }
                }
                ctx2d.putImageData(baseImageData, 0, 0);
            }

            function drawAxes2D(){
                // draw simple axes and ticks inside image canvas (0..100 normalized)
                ctx2d.save();
                ctx2d.strokeStyle = '#9ca3af';
                ctx2d.fillStyle = '#6b7280';
                ctx2d.lineWidth = 1;
                ctx2d.font = '10px system-ui, -apple-system, Segoe UI, Roboto, sans-serif';

                // axes
                ctx2d.beginPath();
                ctx2d.moveTo(0.5, 0.5);
                ctx2d.lineTo(0.5, H - 0.5); // y-axis (left)
                ctx2d.lineTo(W - 0.5, H - 0.5); // x-axis (bottom)
                ctx2d.stroke();

                // ticks every 20 (normalized 0..100 → 6 ticks)
                for (let t = 0; t <= 100; t += 20){
                    const x = ((t / 100) * (W - 1)) + 0.5;
                    // x ticks
                    ctx2d.beginPath();
                    ctx2d.moveTo(x, H - 0.5);
                    ctx2d.lineTo(x, H - 6.5);
                    ctx2d.stroke();
                    // x labels
                    const text = String(t);
                    const tw = ctx2d.measureText(text).width;
                    ctx2d.fillText(text, x - tw / 2, H - 8.5);
                }

                for (let t = 0; t <= 100; t += 20){
                    const y = ((t / 100) * (H - 1));
                    const yy = H - 0.5 - y;
                    // y ticks
                    ctx2d.beginPath();
                    ctx2d.moveTo(0.5, yy);
                    ctx2d.lineTo(6.5, yy);
                    ctx2d.stroke();
                    // y labels
                    const text = String(t);
                    ctx2d.fillText(text, 8.5, yy + 3);
                }
                ctx2d.restore();
            }

            function drawOverlay(y){
                ctx2d.putImageData(baseImageData, 0, 0);
                drawAxes2D();
                ctx2d.save();
                ctx2d.strokeStyle = '#22c1c3';
                ctx2d.lineWidth = 2;
                ctx2d.setLineDash([6, 6]);
                ctx2d.beginPath();
                ctx2d.moveTo(0, y + 0.5);
                ctx2d.lineTo(W, y + 0.5);
                ctx2d.stroke();
                ctx2d.restore();
            }

            function syncPreviewSizing(){
                // Align preview width with signal plot area (chart client width minus left/right margins)
                const left = 40, right = 10;
                const cssWidth = Math.max(0, (chart.clientWidth || chart.width) - (left + right));
                preview.style.marginLeft = left + 'px';
                preview.style.width = cssWidth + 'px';
                preview.style.height = '20px';
                // HiDPI backing store
                preview.width = Math.max(1, Math.round(cssWidth * dpr));
                preview.height = Math.round(20 * dpr);
                pctx.setTransform(1, 0, 0, 1, 0, 0);
                pctx.scale(dpr, dpr);
                pctx.imageSmoothingEnabled = false;
            }

            function drawRowPreview(y){
                // sample from base image data and scale to preview width aligned with plot area
                const src = baseImageData;
                // Offscreen strip at native W x 20
                const strip = document.createElement('canvas');
                strip.width = W; strip.height = 20;
                const sctx = strip.getContext('2d');
                const bar = sctx.createImageData(W, 20);
                for (let col = 0; col < W; col++){
                    const idxSrc = (y * W + col) * 4;
                    const r = src.data[idxSrc];
                    for (let k = 0; k < 20; k++){
                        const idx = (k * W + col) * 4;
                        bar.data[idx] = r;
                        bar.data[idx + 1] = r;
                        bar.data[idx + 2] = r;
                        bar.data[idx + 3] = 255;
                    }
                }
                sctx.putImageData(bar, 0, 0);
                pctx.clearRect(0, 0, preview.width, preview.height);
                // Draw scaled to match chart plot area width
                const destW = preview.clientWidth;
                const destH = preview.clientHeight;
                pctx.drawImage(strip, 0, 0, W, 20, 0, 0, destW, destH);
            }

            function drawSignalChart(y){
                // sample directly from base image data to preserve original grayscale values
                const row = baseImageData.data;

                // HiDPI handling and coordinate system in CSS pixels
                const cDpr = window.devicePixelRatio || 1;
                const cssW = chart.clientWidth || chart.width;
                const cssH = chart.clientHeight || chart.height;
                chart.width = Math.max(1, Math.round(cssW * cDpr));
                chart.height = Math.max(1, Math.round(cssH * cDpr));
                cctx.setTransform(1, 0, 0, 1, 0, 0);
                cctx.clearRect(0, 0, chart.width, chart.height);
                cctx.scale(cDpr, cDpr);
                cctx.imageSmoothingEnabled = false;

                // Plot area in CSS pixels
                const plotLeft = 40, plotRight = cssW - 10;
                const plotTop = 10, plotBottom = cssH - 30;
                const plotW = plotRight - plotLeft;
                const plotH = plotBottom - plotTop;

                // axes with ticks
                cctx.save();
                cctx.strokeStyle = '#e5e7eb';
                cctx.fillStyle = '#6b7280';
                cctx.lineWidth = 1;
                cctx.font = '12px system-ui, -apple-system, Segoe UI, Roboto, sans-serif';
                cctx.beginPath();
                cctx.moveTo(plotLeft, plotTop);
                cctx.lineTo(plotLeft, plotBottom);
                cctx.lineTo(plotRight, plotBottom);
                cctx.stroke();

                // X ticks 0..100 every 20
                for (let t = 0; t <= 100; t += 20){
                    const x = plotLeft + (t / 100) * plotW;
                    cctx.beginPath();
                    cctx.moveTo(x, plotBottom);
                    cctx.lineTo(x, plotBottom + 6);
                    cctx.stroke();
                    const text = String(t);
                    const tw = cctx.measureText(text).width;
                    cctx.fillText(text, x - tw / 2, plotBottom + 18);
                }

                // Y ticks at 0..1
                const yTicks = [0, 0.25, 0.5, 0.75, 1];
                yTicks.forEach((tv) => {
                    const ty = plotTop + (1 - tv) * plotH;
                    cctx.beginPath();
                    cctx.moveTo(plotLeft - 6, ty);
                    cctx.lineTo(plotLeft, ty);
                    cctx.stroke();
                    const label = tv.toFixed(2);
                    const tw = cctx.measureText(label).width;
                    cctx.fillText(label, plotLeft - 8 - tw, ty + 4);
                });
                cctx.restore();

                // waveform
                cctx.save();
                cctx.strokeStyle = '#4f46e5';
                cctx.lineWidth = 2;
                cctx.beginPath();
                for (let x = 0; x < W; x++){
                    const g = row[(y * W + x) * 4];
                    const v = g / 255; // [0,1]
                    const px = plotLeft + (x / (W - 1)) * plotW;
                    const py = plotTop + (1 - v) * plotH;
                    if (x === 0) cctx.moveTo(px, py);
                    else cctx.lineTo(px, py);
                }
                cctx.stroke();
                cctx.restore();
            }

            function revealInteractiveContinue(){
                if (lastInteractionRevealed) return;
                lastInteractionRevealed = true;
                const btn = document.getElementById('continue-after-interactive');
                if (btn) {
                    btn.style.display = 'inline-block';
                    btn.classList.add('show-with-animation');
                }
            }

            function updateRow(y){
                const yy = Math.max(0, Math.min(H - 1, Math.round(y)));
                slider.value = String(yy);
                rowValue.textContent = String(yy);
                drawOverlay(yy);
                drawRowPreview(yy);
                drawSignalChart(yy);
            }

            function handlePointer(evt){
                const rect = canvas2d.getBoundingClientRect();
                const y = (evt.clientY - rect.top) * (H / rect.height);
                updateRow(y);
                revealInteractiveContinue();
            }

            function playLoop(){
                if (!playing) return;
                let y = Number(slider.value);
                y = (y + 1) % H;
                updateRow(y);
                animReq = requestAnimationFrame(playLoop);
            }

            // Initialize
            generatePattern();
            syncPreviewSizing();
            updateRow(Number(slider.value));

            // Events
            slider.addEventListener('input', () => { updateRow(Number(slider.value)); revealInteractiveContinue(); });
            canvas2d.addEventListener('mousedown', (e) => { handlePointer(e); revealInteractiveContinue(); });
            canvas2d.addEventListener('mousemove', (e) => { if (e.buttons & 1) { handlePointer(e); } });
            canvas2d.addEventListener('touchstart', (e) => { if (e.touches[0]) handlePointer(e.touches[0]); revealInteractiveContinue(); }, { passive: true });
            canvas2d.addEventListener('touchmove', (e) => { if (e.touches[0]) handlePointer(e.touches[0]); }, { passive: true });

            playBtn.addEventListener('click', () => {
                playing = !playing;
                playBtn.textContent = playing ? 'Pause' : 'Play';
                revealInteractiveContinue();
                if (playing) {
                    animReq = requestAnimationFrame(playLoop);
                } else if (animReq) {
                    cancelAnimationFrame(animReq);
                    animReq = null;
                }
            });

            function regenAndRedraw(){
                generatePattern();
                updateRow(Number(slider.value));
            }
            freqInput.addEventListener('input', regenAndRedraw);
            curveInput.addEventListener('input', regenAndRedraw);

            // Keep preview aligned on resize
            window.addEventListener('resize', () => { syncPreviewSizing(); updateRow(Number(slider.value)); });

            // Remove broken preloads and missing images warnings by ensuring no invalid preloads
            try {
                const brokenPreloads = document.querySelectorAll('link[rel="preload"][href="about:blank"]');
                brokenPreloads.forEach(el => el.parentNode && el.parentNode.removeChild(el));
            } catch (e) { /* ignore */ }

            // Keyboard: ArrowUp/Down adjust row, Space toggle play
            container.addEventListener('keydown', (e) => {
                if (e.key === 'ArrowUp' || e.key === 'ArrowDown'){
                    e.preventDefault();
                    const delta = e.key === 'ArrowUp' ? -1 : 1;
                    updateRow(Number(slider.value) + delta);
                    revealInteractiveContinue();
                } else if (e.key === ' ') {
                    e.preventDefault();
                    playBtn.click();
                }
            });

            // Focus container for keyboard on click
            container.tabIndex = 0;
        })();
    </script>
</body>
</html>
